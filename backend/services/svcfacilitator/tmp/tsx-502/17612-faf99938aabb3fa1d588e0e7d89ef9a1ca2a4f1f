{"code":"__filename=\"/Users/ddraper005/eff/backend/services/svcfacilitator/src/services/mirrorStore.v2.ts\";(()=>{\n\"use strict\";var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,\"default\",{value:mod,enumerable:true}):target,mod));var __toCommonJS=mod=>__copyProps(__defProp({},\"__esModule\",{value:true}),mod);var mirrorStore_v2_exports={};__export(mirrorStore_v2_exports,{ColdStartNoDbNoLkgError:()=>ColdStartNoDbNoLkgError,MirrorStoreV2:()=>MirrorStoreV2});module.exports=__toCommonJS(mirrorStore_v2_exports);var import_fs=require(\"fs\");var path=__toESM(require(\"path\"));var import_Logger=require(\"@nv/shared/logger/Logger\");var import_serviceConfig=require(\"@nv/shared/contracts/serviceConfig.wire\");class ColdStartNoDbNoLkgError extends Error{static{__name(this,\"ColdStartNoDbNoLkgError\")}constructor(){super(\"Cold start failed: DB unavailable and no FS LKG present\");this.name=\"ColdStartNoDbNoLkgError\"}}let _inMemory=null;let _expiresAt=0;class MirrorStoreV2{constructor(opts){this.log=(0,import_Logger.getLogger)().bind({service:\"svcfacilitator\",component:\"MirrorStoreV2\",url:\"/services/mirrorStore.v2\"});this.ttlMs=opts.ttlMs;this.loader=opts.loader;this.fsPath=opts.fsPath}static{__name(this,\"MirrorStoreV2\")}getMirror(){return _inMemory?.map??Object.create(null)}count(){return Object.keys(_inMemory?.map??{}).length}async replaceWithPush(map){const snap={map:map??Object.create(null),source:\"db\",fetchedAt:new Date().toISOString()};this.setInMemory(snap);await this.saveFsLkg(snap.map,snap.fetchedAt);this.log.debug(\"SVF505 mirror_replaced_by_push\",{count:Object.keys(snap.map).length});return snap}async getWithTtl(){const now=Date.now();if(_inMemory&&now<_expiresAt){return _inMemory}try{this.log.debug(\"SVF500 mirror_refresh_start\",{strategy:\"db\"});const res=await this.loader.loadFullMirror();if(res&&res.activeCount>0){const snap={map:res.mirror,source:\"db\",fetchedAt:new Date().toISOString()};this.setInMemory(snap);await this.saveFsLkg(snap.map,snap.fetchedAt);this.log.debug(\"SVF510 mirror_refresh_ok\",{source:\"db\",activeCount:Object.keys(snap.map).length});return snap}this.log.warn(\"SVF520 mirror_refresh_empty\",{source:\"db\"})}catch(err){this.log.warn(\"SVF525 mirror_refresh_db_error\",{error:String(err)})}try{const fsLkg=await this.loadFsLkgValidated();if(fsLkg){const snap={map:fsLkg.payload,source:\"lkg\",fetchedAt:fsLkg.updatedAt};this.setInMemory(snap);this.log.warn(\"SVF531 mirror_fs_lkg_served\",{count:Object.keys(snap.map).length,path:this.fsPath});return snap}}catch(err){this.log.warn(\"SVF532 mirror_fs_lkg_error\",{error:String(err)})}this.log.error(\"SVF541 cold_start_no_db_no_lkg\");throw new ColdStartNoDbNoLkgError}setInMemory(snap){_inMemory=snap;_expiresAt=Date.now()+Math.max(0,this.ttlMs||0)}async saveFsLkg(map,whenIso){if(!this.fsPath)return;const abs=path.isAbsolute(this.fsPath)?this.fsPath:path.resolve(process.cwd(),this.fsPath);const payload=JSON.stringify({schema:\"mirror@v2\",updatedAt:whenIso,payload:map},null,2);await import_fs.promises.mkdir(path.dirname(abs),{recursive:true});const tmp=`${abs}.tmp.${Date.now()}`;await import_fs.promises.writeFile(tmp,payload,\"utf8\");await import_fs.promises.rename(tmp,abs)}async loadFsLkgValidated(){if(!this.fsPath)return null;const abs=path.isAbsolute(this.fsPath)?this.fsPath:path.resolve(process.cwd(),this.fsPath);try{const data=await import_fs.promises.readFile(abs,\"utf8\");const raw=JSON.parse(data);if(!raw||raw.schema!==\"mirror@v2\")return null;if(!raw.payload||!raw.updatedAt)return null;const parsed=import_serviceConfig.MirrorJSONSchema.safeParse(raw.payload);if(!parsed.success){const first=parsed.error.issues?.[0];const at=first?.path?.join(\".\")||\"<root>\";throw new Error(`FS LKG failed schema validation at ${at}: ${first?.message}`)}return{schema:\"mirror@v2\",updatedAt:String(raw.updatedAt),payload:parsed.data}}catch{return null}}}0&&(module.exports={ColdStartNoDbNoLkgError,MirrorStoreV2});\n})()\n","warnings":[],"map":{"version":3,"mappings":"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","names":["fs"],"ignoreList":[],"sources":["/Users/ddraper005/eff/backend/services/svcfacilitator/src/services/mirrorStore.v2.ts"],"sourcesContent":[null]}}