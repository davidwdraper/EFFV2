{"code":"__filename=\"/Users/ddraper005/eff/backend/services/shared/src/base/RepoBase.ts\";(()=>{\nvar __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toCommonJS=mod=>__copyProps(__defProp({},\"__esModule\",{value:true}),mod);var RepoBase_exports={};__export(RepoBase_exports,{RepoBase:()=>RepoBase});module.exports=__toCommonJS(RepoBase_exports);class RepoBase{static{__name(this,\"RepoBase\")}db;collection;dbName;logger;retry;constructor(db,cfg){if(!cfg.collection||!cfg.collection.trim()){throw new Error(\"RepoBase: collection is required\")}this.db=db;this.collection=cfg.collection.trim();this.dbName=cfg.dbName;this.logger=cfg.logger;this.retry={attempts:cfg.retry?.attempts??3,baseDelayMs:cfg.retry?.baseDelayMs??50,maxDelayMs:cfg.retry?.maxDelayMs??1e3}}async coll(){const c=await this.db.getCollection(this.collection,this.dbName);return c}async ensureIndexes(indexes){if(!indexes||indexes.length===0)return;const col=await this.coll();await col.createIndexes(indexes);this.logger?.info(\"[RepoBase] indexes ensured\",{collection:this.collection,count:indexes.length})}async withRetry(fn,label=\"repo.op\"){const{attempts,baseDelayMs,maxDelayMs}=this.retry;let lastErr;for(let i=0;i<attempts;i++){try{return await fn()}catch(err){lastErr=err;const delay=Math.min(maxDelayMs,Math.floor(baseDelayMs*2**i+Math.random()*baseDelayMs));this.logger?.warn(`[RepoBase] ${label} failed (attempt ${i+1}/${attempts})`,{err:String(err)});await sleep(delay)}}this.logger?.error(`[RepoBase] ${label} failed after ${attempts} attempts`,{err:String(lastErr)});throw lastErr}}function sleep(ms){return new Promise(res=>setTimeout(res,ms))}__name(sleep,\"sleep\");0&&(module.exports={RepoBase});\n})()\n","warnings":[],"map":{"version":3,"mappings":";suBAAA,yHAgCO,MAAe,QAA2C,CAhCjE,MAgCiE,yBAC5C,GACA,WACA,OACA,OACF,MAEjB,YAAY,GAAc,IAA2B,CACnD,GAAI,CAAC,IAAI,YAAc,CAAC,IAAI,WAAW,KAAK,EAAG,CAC7C,MAAM,IAAI,MAAM,kCAAkC,CACpD,CACA,KAAK,GAAK,GACV,KAAK,WAAa,IAAI,WAAW,KAAK,EACtC,KAAK,OAAS,IAAI,OAClB,KAAK,OAAS,IAAI,OAGlB,KAAK,MAAQ,CACX,SAAU,IAAI,OAAO,UAAY,EACjC,YAAa,IAAI,OAAO,aAAe,GACvC,WAAY,IAAI,OAAO,YAAc,GACvC,CACF,CAGA,MAAgB,MAAkC,CAChD,MAAM,EAAK,MAAM,KAAK,GAAG,cACvB,KAAK,WACL,KAAK,MACP,EACA,OAAO,CACT,CAGA,MAAgB,cAAc,QAA4C,CACxE,GAAI,CAAC,SAAW,QAAQ,SAAW,EAAG,OACtC,MAAM,IAAM,MAAM,KAAK,KAAK,EAC5B,MAAM,IAAI,cAAc,OAAO,EAC/B,KAAK,QAAQ,KAAK,6BAA8B,CAC9C,WAAY,KAAK,WACjB,MAAO,QAAQ,MACjB,CAAQ,CACV,CAGA,MAAgB,UACd,GACA,MAAQ,UACI,CACZ,KAAM,CAAE,SAAU,YAAa,UAAW,EAAI,KAAK,MACnD,IAAI,QACJ,QAAS,EAAI,EAAG,EAAI,SAAU,IAAK,CACjC,GAAI,CACF,OAAO,MAAM,GAAG,CAClB,OAAS,IAAK,CACZ,QAAU,IACV,MAAM,MAAQ,KAAK,IACjB,WACA,KAAK,MAAM,YAAc,GAAK,EAAI,KAAK,OAAO,EAAI,WAAW,CAC/D,EACA,KAAK,QAAQ,KACX,cAAc,KAAK,oBAAoB,EAAI,CAAC,IAAI,QAAQ,IACxD,CAAE,IAAK,OAAO,GAAG,CAAE,CACrB,EACA,MAAM,MAAM,KAAK,CACnB,CACF,CACA,KAAK,QAAQ,MACX,cAAc,KAAK,iBAAiB,QAAQ,YAC5C,CAAE,IAAK,OAAO,OAAO,CAAE,CACzB,EACA,MAAM,OACR,CACF,CAGA,SAAS,MAAM,GAA2B,CACxC,OAAO,IAAI,QAAS,KAAQ,WAAW,IAAK,EAAE,CAAC,CACjD,CAFS","names":[],"ignoreList":[],"sources":["/Users/ddraper005/eff/backend/services/shared/src/base/RepoBase.ts"],"sourcesContent":[null]}}