adr0057-id-generation-and-validation

# ADR-0057 — ID Generation and Validation

## Context
Frontend clients occasionally need to provide their own IDs (e.g., for deduping or correlation), but the backend must remain safe from duplicate‑key errors and malformed identifiers.
Historically, some services allowed arbitrary strings as `id`, which led to inconsistent DB states and non‑canonical joins. The goal is a unified rule: **IDs must be valid UUIDv4**, lowercase, immutable once set, and every persisted DTO must have one—whether supplied by the client or generated by the backend.

## Decision
1. **DtoBase**
   - Provides a one‑shot `id` setter: if an `id` is already present, a replacement attempt is a **no‑op** and emits a **WARN** (`logger.warn("Attempted to overwrite id; operation ignored")`). This should never happen under normal operation and must be investigated.
   - On first assignment, validates the value against the UUIDv4 regex (case‑insensitive):
     ```regex
     /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i
     ```
   - If the value passes, it is normalized to lowercase and stored.
   - If invalid, throws **400 Bad Request** with a problem detail body including:
     ```json
     { "code": "INVALID_ID_FORMAT", "detail": "id must be a UUIDv4" }
     ```

2. **DbWriter**
   - On create, if `dto.id` is missing, DbWriter generates a **UUIDv4** and sets it via the DTO setter **before** calling `toJson()` (single‑purpose `toJson()`).
   - Regardless of who provided the id (client, controller, or DbWriter), the create response **must include the effective `id`** in the returned DtoBag so callers can use it for downstream foreign keys.

3. **Controllers**
   - May set an `id` early (e.g., WAL correlation or tracing) but must use the DTO setter (gets validation and immutability for free).
   - Must not modify an existing `id` (attempt should be a WARN no‑op as above).

4. **Frontend & Wire Contract**
   - `PUT /create` payloads **may omit** `id`. If an `id` is provided, it **must be UUIDv4**.
   - Responses **always** include the effective `id` within the DtoBag.
   - Edge payloads use **DtoBag**, even for singletons: `{ items: [ { type: string, doc: {...} } ], meta?: {...} }`.

5. **Validation Scope**
   - Validation is centralized in the DTO layer (on assignment). DbWriter and controllers rely on the DTO contract; no duplicate validation required elsewhere.

## Consequences
- Prevents invalid or duplicate key values at persistence time.
- Simplifies smoke testing: tests **can** seed valid UUIDv4s (e.g., for duplicate‑create) or let the backend generate ids.
- Keeps the backend self‑healing—when no id is provided, it auto‑generates a safe one.
- Centralizes id behavior in one place (DtoBase) to avoid divergence across services.
- Adds observability: WARN on attempted id overwrite highlights code smell paths.

## Implementation Notes
- Use a standard UUIDv4 generator in shared utilities.
- Normalize stored ids to lowercase.
- Unit tests must cover:
  - valid UUIDv4 assignment
  - rejection of invalid formats
  - auto‑generation path in DbWriter
  - immutability once set (WARN on attempted overwrite)
- Smokes may run with or without seeded ids; both paths should pass.
- All create responses must include the final id in the returned DtoBag.

## Alternatives Considered
- **Allow any string id:** rejected—collision and data‑quality risks.
- **Use UUIDv7 / ULID:** deferred; revisit if ordering characteristics become desirable.
- **Backend‑only id creation:** rejected—prevents deterministic keys for clients that need them.

## References
- ADR‑0040 (DTO‑Only Persistence)
- ADR‑0041–0043 (Controller/Handler pipeline)
- ADR‑0044 (SvcEnv DTO contract)
- ADR‑0050 (Wire Bag Envelope)
