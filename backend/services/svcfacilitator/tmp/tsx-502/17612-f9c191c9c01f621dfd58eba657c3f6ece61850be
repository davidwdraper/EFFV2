{"code":"__filename=\"/Users/ddraper005/eff/backend/services/svcfacilitator/src/bootstrap.v2.ts\";(()=>{\n\"use strict\";var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,\"default\",{value:mod,enumerable:true}):target,mod));var __toCommonJS=mod=>__copyProps(__defProp({},\"__esModule\",{value:true}),mod);var bootstrap_v2_exports={};__export(bootstrap_v2_exports,{createSvcFacilitatorApp:()=>createSvcFacilitatorApp});module.exports=__toCommonJS(bootstrap_v2_exports);var import_express=__toESM(require(\"express\"));var import_body_parser=__toESM(require(\"body-parser\"));var import_Logger=require(\"@nv/shared/logger/Logger\");var import_db=require(\"./services/db.v2\");var import_ServiceConfigsRepo=require(\"./repos/ServiceConfigsRepo\");var import_RoutePoliciesRepo=require(\"./repos/RoutePoliciesRepo\");var import_MirrorDbLoader=require(\"./services/MirrorDbLoader.v2\");var import_mirrorStore=require(\"./services/mirrorStore.v2\");var import_MirrorController=require(\"./controllers/MirrorController.v2\");const log=(0,import_Logger.getLogger)().bind({service:\"svcfacilitator\",component:\"bootstrap\",url:\"/bootstrap.v2\"});function requireEnv(name){const v=process.env[name];if(!v||v.trim()===\"\")throw new Error(`Missing required env: ${name}`);return v.trim()}__name(requireEnv,\"requireEnv\");function requireIntEnv(name){const raw=requireEnv(name);const n=Number(raw);if(!Number.isFinite(n))throw new Error(`Env ${name} must be a number`);return Math.trunc(n)}__name(requireIntEnv,\"requireIntEnv\");async function createSvcFacilitatorApp(){const dbClient=(0,import_db.getSvcFacilitatorDb)();log.info(\"SVF210 db_connect_ok\",{dbName:dbClient?.dbName});const parentsRepo=new import_ServiceConfigsRepo.ServiceConfigsRepo(dbClient);const policiesRepo=new import_RoutePoliciesRepo.RoutePoliciesRepo(dbClient);const loader=new import_MirrorDbLoader.MirrorDbLoader(parentsRepo,policiesRepo);const ttlMs=requireIntEnv(\"SVCCONFIG_MIRROR_TTL_MS\");const fsPath=requireEnv(\"SVCCONFIG_LKG_PATH\");const mirrorStore=new import_mirrorStore.MirrorStoreV2({ttlMs,loader,fsPath});await mirrorStore.getWithTtl();const app=(0,import_express.default)();app.get(\"/api/svcfacilitator/v1/health\",(_req,res)=>{res.status(200).json({ok:true,service:\"svcfacilitator\"})});app.use(import_body_parser.default.json({limit:\"1mb\"}));const mirrorController=new import_MirrorController.MirrorController(mirrorStore);app.get(\"/api/svcfacilitator/v1/mirror\",async(_req,res,next)=>{try{const payload=await mirrorController.getMirror();res.status(200).json(payload)}catch(e){next(e)}});app.post(\"/api/svcfacilitator/v1/mirror\",async(req,res,next)=>{try{await mirrorController.mirrorLoad(req,res)}catch(e){next(e)}});return{app,mirrorStore}}__name(createSvcFacilitatorApp,\"createSvcFacilitatorApp\");0&&(module.exports={createSvcFacilitatorApp});\n})()\n","warnings":[],"map":{"version":3,"mappings":";8/BAAA,mKAWA,mBAAmE,4BACnE,uBAAuB,gCAEvB,kBAA0B,oCAC1B,cAAoC,4BAEpC,8BAAmC,sCACnC,6BAAkC,qCAClC,0BAA+B,wCAC/B,uBAA8B,qCAC9B,4BAAiC,6CAEjC,MAAM,OAAM,yBAAU,EAAE,KAAK,CAC3B,QAAS,iBACT,UAAW,YACX,IAAK,eACP,CAAC,EAGD,SAAS,WAAW,KAAsB,CACxC,MAAM,EAAI,QAAQ,IAAI,IAAI,EAC1B,GAAI,CAAC,GAAK,EAAE,KAAK,IAAM,GAAI,MAAM,IAAI,MAAM,yBAAyB,IAAI,EAAE,EAC1E,OAAO,EAAE,KAAK,CAChB,CAJS,gCAKT,SAAS,cAAc,KAAsB,CAC3C,MAAM,IAAM,WAAW,IAAI,EAC3B,MAAM,EAAI,OAAO,GAAG,EACpB,GAAI,CAAC,OAAO,SAAS,CAAC,EAAG,MAAM,IAAI,MAAM,OAAO,IAAI,mBAAmB,EACvE,OAAO,KAAK,MAAM,CAAC,CACrB,CALS,sCAQT,eAAsB,yBAGnB,CAED,MAAM,YAAW,+BAAoB,EACrC,IAAI,KAAK,uBAAwB,CAAE,OAAS,UAAkB,MAAO,CAAC,EAGtE,MAAM,YAAc,IAAI,6CAAmB,QAAQ,EACnD,MAAM,aAAe,IAAI,2CAAkB,QAAQ,EACnD,MAAM,OAAS,IAAI,qCAAe,YAAa,YAAY,EAE3D,MAAM,MAAQ,cAAc,yBAAyB,EACrD,MAAM,OAAS,WAAW,oBAAoB,EAC9C,MAAM,YAAc,IAAI,iCAAc,CAAE,MAAO,OAAQ,MAAO,CAAC,EAG/D,MAAM,YAAY,WAAW,EAG7B,MAAM,OAAM,eAAAA,SAAQ,EAGpB,IAAI,IAAI,gCAAiC,CAAC,KAAe,MAAkB,CACzE,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,GAAI,KAAM,QAAS,gBAAiB,CAAC,CAC9D,CAAC,EAGD,IAAI,IAAI,mBAAAC,QAAW,KAAK,CAAE,MAAO,KAAM,CAAC,CAAC,EAGzC,MAAM,iBAAmB,IAAI,yCAAiB,WAAW,EAGzD,IAAI,IAAI,gCAAiC,MAAO,KAAM,IAAK,OAAS,CAClE,GAAI,CACF,MAAM,QAAU,MAAM,iBAAiB,UAAU,EACjD,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,CAC9B,OAAS,EAAG,CACV,KAAK,CAAC,CACR,CACF,CAAC,EAED,IAAI,KAAK,gCAAiC,MAAO,IAAK,IAAK,OAAS,CAClE,GAAI,CACF,MAAM,iBAAiB,WAAW,IAAK,GAAG,CAC5C,OAAS,EAAG,CACV,KAAK,CAAC,CACR,CACF,CAAC,EAID,MAAO,CAAE,IAAK,WAAY,CAC5B,CAvDsB","names":["express","bodyParser"],"ignoreList":[],"sources":["/Users/ddraper005/eff/backend/services/svcfacilitator/src/bootstrap.v2.ts"],"sourcesContent":[null]}}