{"code":"__filename=\"/Users/ddraper005/eff/backend/services/svcfacilitator/src/controllers/MirrorController.v2.ts\";(()=>{\n\"use strict\";var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toCommonJS=mod=>__copyProps(__defProp({},\"__esModule\",{value:true}),mod);var MirrorController_v2_exports={};__export(MirrorController_v2_exports,{MirrorController:()=>MirrorController});module.exports=__toCommonJS(MirrorController_v2_exports);var import_ControllerBase=require(\"@nv/shared/base/ControllerBase\");var import_SvcReceiver=require(\"@nv/shared/svc/SvcReceiver\");var import_mirrorStore=require(\"../services/mirrorStore.v2\");function isHandlerResult(e){return!!e&&typeof e===\"object\"&&\"status\"in e&&\"body\"in e}__name(isHandlerResult,\"isHandlerResult\");class MirrorController extends import_ControllerBase.ControllerBase{constructor(store){super({service:\"svcfacilitator\",context:{component:\"MirrorController\"}});this.store=store;this.rx=new import_SvcReceiver.SvcReceiver(\"svcfacilitator\")}static{__name(this,\"MirrorController\")}async getMirror(){try{const snap=await this.store.getWithTtl();const map=snap?.map??Object.create(null);const count=Object.keys(map).length;if(count===0){this.log.warn({stage:\"getMirror\",source:snap?.source,fetchedAt:snap?.fetchedAt},\"mirror_empty_snapshot\")}else{this.log.debug({stage:\"getMirror\",source:snap.source,fetchedAt:snap.fetchedAt,count},\"mirror_snapshot_ok\")}return{mirror:map,meta:{source:snap.source,fetchedAt:snap.fetchedAt,count}}}catch(err){if(err instanceof import_mirrorStore.ColdStartNoDbNoLkgError){this.log.error({stage:\"getMirror\",err:err.message},\"cold_start_no_db_no_lkg\");throw{status:503,body:{type:\"about:blank\",title:\"mirror_unavailable\",detail:\"Cold start failed: DB unavailable and no FS LKG present\"}}}this.log.error({stage:\"getMirror\",err:String(err)},\"mirror_read_error\");throw{status:500,body:{type:\"about:blank\",title:\"mirror_unavailable\",detail:\"Failed to load mirror snapshot\"}}}}async mirrorLoad(req,res){await this.rx.receive({method:req.method,url:req.originalUrl??req.url,headers:req.headers,params:req.params,query:req.query,body:req.body},{status:__name(code=>{res.status(code);return res},\"status\"),setHeader:__name((k,v)=>res.setHeader(k,v),\"setHeader\"),json:__name(payload=>res.json(payload),\"json\")},async({requestId,body})=>{const rawMirror=body?.mirror;if(!rawMirror||typeof rawMirror!==\"object\"||Array.isArray(rawMirror)){this.log.warn({stage:\"mirrorLoad\",requestId},\"invalid_payload_no_mirror\");return this.bad(400,requestId,\"invalid_payload\",\"expected { mirror: Record<string, ServiceConfigJSON> }\")}const outputMap=rawMirror;try{const snap=await this.store.replaceWithPush(outputMap);return{status:200,body:{ok:true,requestId,accepted:true,services:Object.keys(outputMap).length,source:snap.source,lkgSaved:true,fetchedAt:snap.fetchedAt}}}catch(e){this.log.error({stage:\"mirrorLoad.store\",requestId,error:String(e)},\"mirror_store_replace_failed\");return{status:200,body:{ok:true,requestId,accepted:true,services:Object.keys(outputMap).length,source:\"db\",lkgSaved:false,lkgError:String(e)}}}})}bad(status,requestId,error,detail){return{status,body:{ok:false,requestId,error,detail}}}}0&&(module.exports={MirrorController});\n})()\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/ddraper005/eff/backend/services/svcfacilitator/src/controllers/MirrorController.v2.ts"],"sourcesContent":[null]}}