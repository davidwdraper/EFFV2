{"code":"__filename=\"/Users/ddraper005/eff/backend/services/svcfacilitator/src/services/MirrorDbLoader.v2.ts\";(()=>{\n\"use strict\";var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toCommonJS=mod=>__copyProps(__defProp({},\"__esModule\",{value:true}),mod);var MirrorDbLoader_v2_exports={};__export(MirrorDbLoader_v2_exports,{MirrorDbLoader:()=>MirrorDbLoader});module.exports=__toCommonJS(MirrorDbLoader_v2_exports);var import_Logger=require(\"@nv/shared/logger/Logger\");var import_Mirror=require(\"@nv/shared/domain/Mirror\");var import_ServiceConfig=require(\"@nv/shared/domain/ServiceConfig\");class MirrorDbLoader{constructor(parentsRepo,policiesRepo){this.parentsRepo=parentsRepo;this.policiesRepo=policiesRepo;this.log=(0,import_Logger.getLogger)().bind({service:\"svcfacilitator\",component:\"MirrorDbLoaderV2\",url:\"/services/MirrorDbLoader.v2\"})}static{__name(this,\"MirrorDbLoader\")}async loadFullMirror(){this.log.debug(\"SVF300 load_from_db_start\",{source:\"repos\\u2192domain\\u2192mirror\"});const started=Date.now();const parents=await this.parentsRepo.findVisibleParents();const latency=Date.now()-started;const rawCount=parents.length;if(rawCount===0){this.log.debug(\"SVF320 load_from_db_empty\",{reason:\"no_docs\"});return null}const entities=[];const errors=[];for(const row of parents){const kSlug=String(row?.slug??\"<unknown>\");const kVer=String(row?.version??\"<unknown>\");const draftKey=`${kSlug}@${kVer}`;try{const parentId=row._id;const[edgeRows,s2sRows]=await Promise.all([this.policiesRepo.findEnabledEdgeByParent(parentId),this.policiesRepo.findEnabledS2SByParent(parentId)]);const edgePolicies=edgeRows.map(edgeToDomain);const s2sPolicies=s2sRows.map(s2sToDomain);const entity=import_ServiceConfig.ServiceConfig.fromDb(row,{edge:edgePolicies,s2s:s2sPolicies});entities.push(entity)}catch(err){const msg=String(err);errors.push({key:draftKey,error:msg});this.log.warn(\"SVF415 invalid_parent_or_policy\",{key:draftKey,error:msg})}}if(errors.length>0){throw new Error(`invalid_service_config_fields count=${errors.length}`)}if(entities.length===0){this.log.debug(\"SVF320 load_from_db_empty\",{reason:\"no_valid_entities\",rawCount});return null}const mirror=import_Mirror.Mirror.fromArray(entities);const wire=mirror.toObject();this.log.debug(\"SVF310 load_from_db_ok\",{rawCount,activeCount:mirror.size(),tookMs:latency,keys:mirror.keys()});return{mirror:wire,rawCount,activeCount:mirror.size(),errors}}}function asIso(v){if(v instanceof Date)return v.toISOString();if(typeof v===\"string\"&&v.length>0)return v;const d=new Date(v);if(!Number.isNaN(d.getTime()))return d.toISOString();throw new Error(\"updatedAt must be a Date or ISO string\")}__name(asIso,\"asIso\");function edgeToDomain(p){return{type:\"Edge\",svcconfigId:p.svcconfigId,_id:p._id,slug:String(p.slug),method:String(p.method),path:String(p.path),bearerRequired:Boolean(p.bearerRequired),enabled:Boolean(p.enabled),updatedAt:asIso(p.updatedAt),notes:p.notes!=null?String(p.notes):void 0,minAccessLevel:p.minAccessLevel!=null?Number(p.minAccessLevel):void 0}}__name(edgeToDomain,\"edgeToDomain\");function s2sToDomain(p){return{type:\"S2S\",svcconfigId:p.svcconfigId,_id:p._id,slug:String(p.slug),method:String(p.method),path:String(p.path),enabled:Boolean(p.enabled),updatedAt:asIso(p.updatedAt),notes:p.notes!=null?String(p.notes):void 0}}__name(s2sToDomain,\"s2sToDomain\");0&&(module.exports={MirrorDbLoader});\n})()\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/ddraper005/eff/backend/services/svcfacilitator/src/services/MirrorDbLoader.v2.ts"],"sourcesContent":[null]}}